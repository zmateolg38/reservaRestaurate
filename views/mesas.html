<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Mesas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <style>

body {
    background-color: #f8f9fa;
}

.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.table th {
    background-color: #f1f1f1;
}

.badge {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

.badge-disponible {
    background-color: #28a745;
}

.badge-ocupada {
    background-color: #dc3545;
}

.badge-reservada {
    background-color: #ffc107;
    color: #212529;
}

.badge-fuera-de-servicio {
    background-color: #6c757d;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.actions-column {
    white-space: nowrap;
}

    </style>

</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gestión de Mesas</h1>
        
        <!-- Formulario para agregar nueva mesa -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Agregar Nueva Mesa</h5>
            </div>
            <div class="card-body">
                <form id="mesaForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" required>
                        </div>
                        <div class="col-md-3">
                            <label for="capacidad" class="form-label">Capacidad</label>
                            <input type="number" class="form-control" id="capacidad" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" required>
                                <option value="DISPONIBLE">Disponible</option>
                                <option value="OCUPADA">Ocupada</option>
                                <option value="RESERVADA">Reservada</option>
                                <option value="FUERA_DE_SERVICIO">Fuera de servicio</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">Agregar Mesa</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Listado de mesas -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Listado de Mesas</h5>
                <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Actualizar</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Capacidad</th>
                                <th>Estado</th>
                                <th>Activa</th>
                            </tr>
                        </thead>
                        <tbody id="mesasTableBody">
                            <!-- Las mesas se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado -->
    <div class="modal fade" id="estadoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Estado de Mesa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select class="form-select" id="nuevoEstado">
                        <option value="DISPONIBLE">Disponible</option>
                        <option value="OCUPADA">Ocupada</option>
                        <option value="RESERVADA">Reservada</option>
                        <option value="FUERA_DE_SERVICIO">Fuera de servicio</option>
                    </select>
                    <input type="hidden" id="mesaIdEstado">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarEstado">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    
    document.addEventListener('DOMContentLoaded', function() {
    const API_BASE_URL = 'http://localhost:8080/api/mesas';
    const mesasTableBody = document.getElementById('mesasTableBody');
    const mesaForm = document.getElementById('mesaForm');
    const refreshBtn = document.getElementById('refreshBtn');
    const estadoModal = new bootstrap.Modal(document.getElementById('estadoModal'));
    const confirmarEstadoBtn = document.getElementById('confirmarEstado');
    const nuevoEstadoSelect = document.getElementById('nuevoEstado');
    const mesaIdEstadoInput = document.getElementById('mesaIdEstado');

    // Cargar mesas al iniciar
    cargarMesas();

    // Evento para agregar nueva mesa
    mesaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        agregarMesa();
    });

    // Evento para actualizar la lista
    refreshBtn.addEventListener('click', cargarMesas);

    // Evento para confirmar cambio de estado
    confirmarEstadoBtn.addEventListener('click', cambiarEstadoMesa);

    // Función para cargar todas las mesas
    function cargarMesas() {
        fetch(API_BASE_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener las mesas');
                }
                return response.json();
            })
            .then(data => {
                mostrarMesas(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar las mesas');
            });
    }

    // Función para mostrar las mesas en la tabla
    function mostrarMesas(mesas) {
        mesasTableBody.innerHTML = '';
        
        mesas.forEach(mesa => {
            const row = document.createElement('tr');
            
            // Determinar clase CSS para el estado
            let estadoClass = '';
            switch(mesa.estado) {
                case 'DISPONIBLE':
                    estadoClass = 'badge-disponible';
                    break;
                case 'OCUPADA':
                    estadoClass = 'badge-ocupada';
                    break;
                case 'RESERVADA':
                    estadoClass = 'badge-reservada';
                    break;
                case 'FUERA_DE_SERVICIO':
                    estadoClass = 'badge-fuera-de-servicio';
                    break;
            }
            
            row.innerHTML = `
                <td>${mesa.numero}</td>
                <td>${mesa.capacidad}</td>
                <td><span class="badge ${estadoClass}">${mesa.estado.toLowerCase().replace(/_/g, ' ')}</span></td>
                <td>${mesa.activa ? 'Sí' : 'No'}</td>
            `;
            
            mesasTableBody.appendChild(row);
        });

        // Agregar eventos a los botones recién creados
        document.querySelectorAll('.liberar-btn').forEach(btn => {
            btn.addEventListener('click', liberarMesa);
        });

        document.querySelectorAll('.estado-btn').forEach(btn => {
            btn.addEventListener('click', prepararCambioEstado);
        });
    }

    // Función para agregar una nueva mesa
    function agregarMesa() {
        const numero = document.getElementById('numero').value;
        const capacidad = document.getElementById('capacidad').value;
        const estado = document.getElementById('estado').value;
        
        const nuevaMesa = {
            numero: numero,
            capacidad: parseInt(capacidad),
            estado: estado,
            activa: true
        };
        
        fetch(API_BASE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(nuevaMesa)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al agregar la mesa');
            }
            return response.json();
        })
        .then(() => {
            alert('Mesa agregada correctamente');
            mesaForm.reset();
            cargarMesas();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al agregar la mesa');
        });
    }

    // Función para liberar una mesa
    function liberarMesa(e) {
        const mesaId = e.target.getAttribute('data-id');
        
        fetch(`${API_BASE_URL}/${mesaId}/liberar`, {
            method: 'PUT'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al liberar la mesa');
            }
            return response.json();
        })
        .then(() => {
            alert('Mesa liberada correctamente');
            cargarMesas();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al liberar la mesa');
        });
    }

    // Función para preparar el cambio de estado
    function prepararCambioEstado(e) {
        const mesaId = e.target.getAttribute('data-id');
        mesaIdEstadoInput.value = mesaId;
        estadoModal.show();
    }

    // Función para cambiar el estado de una mesa
    function cambiarEstadoMesa() {
        const mesaId = mesaIdEstadoInput.value;
        const nuevoEstado = nuevoEstadoSelect.value;
        
        fetch(`${API_BASE_URL}/${mesaId}/estado?estado=${nuevoEstado}`, {
            method: 'PUT'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al cambiar el estado de la mesa');
            }
            return response.json();
        })
        .then(() => {
            alert('Estado de la mesa actualizado correctamente');
            estadoModal.hide();
            cargarMesas();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cambiar el estado de la mesa');
        });
    }
});
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>

</body>
</html>